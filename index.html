<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --error: #e74c3c;
            --text: #2c3e50;
            --bg: #f5f6fa;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø¹Ø§Ù…Ø© */
        body {
            
            font-family: 'Tajawal', sans-serif;
            background: var(--bg);
            min-height: 100vh;
        }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© */
        .auth-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--primary);
            color: white;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .main-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 2rem;
        }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .data-table th, 
        .data-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
        }

        .entry-form {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 2rem auto;
            padding: 1rem;
            border-radius: 10px;
        }

        /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
        footer {
            text-align: center;
            padding: 1rem;
            background: var(--primary);
            color: white;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        @media (max-width: 768px) {
  .dashboard-header {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
  }
  
  .data-table th, 
  .data-table td {
    padding: 8px;
    font-size: 14px;
  }
}
/* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
button {
  transition: transform 0.2s, box-shadow 0.2s;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}
.form-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none; /* Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ù…Ø®ÙÙŠ */
    justify-content: center;
    align-items: center;
    z-index: 1000; /* ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ±Ù‡ ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
}
contentSection {
    display: block !important;
    visibility: visible !important;
}

    </style>
</head>
<body>
    
    <!-- ØµÙØ­Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authSection" class="auth-container">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <form id="loginForm">
            <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
            <input type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
            <button type="submit">Ø¯Ø®ÙˆÙ„</button>
        </form>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="dashboard" style="display: none;">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="dashboard-header">
            <div id="currentTime"></div>
            <h1> Deals 2 Buy </h1>
            <div>Ù…Ø±Ø­Ø¨Ø§ØŒ <span id="username"></span></div>
        </div>

        <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="main-buttons">
            <button onclick="showSection('inputs')">Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</button>
            <button onclick="showSection('expenses')">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
            <button onclick="showSection('total')">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª -->
        <div id="contentSection"></div>
    </div>

    <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
    <footer>Â© Ibrahim Smahin 2025</footer>

<script>
    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† HTML
window.showForm = showForm;
window.closeForm = closeForm;
window.submitForm = submitForm;


// ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØªØ³
const API_URL = 'https://script.google.com/macros/s/AKfycbzo55a8d-na8labiP4E_2p1moJviEjQcybymODDJDBoZWW5O-kcipdKzAl4l6cQI0Slwg/exec';

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
let currentUser = null;
let records = {
    inputs: [],
    expenses: []
};

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = e.target[0].value;
    const password = e.target[1].value;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„API)
    if(username === 'admin' && password === 'admin123') {
        currentUser = username;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('username').textContent = username;
        startClock();
        loadData();
    }
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadData() {
    try {
        const response = await fetch(`${API_URL}?action=getAll`);
        const data = await response.json();
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:", data);
        
        records.inputs = data.inputs || [];
        records.expenses = data.expenses || [];
        
        updateTables();
    } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    }
}
// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª
function startClock() {
    setInterval(() => {
        const options = { 
            timeZone: 'Asia/Gaza',
            hour12: true,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        
        document.getElementById('currentTime').textContent = 
            new Date().toLocaleString('ar-EG', options);
    }, 1000);
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª
function addRecord(type, data) {
    const newRecord = {
        id: generateId(),
        ...data,
        date: new Date().toLocaleString('ar-EG', { 
            timeZone: 'Asia/Gaza',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        })
    };
    
    records[type].push(newRecord);
    updateTables();
    saveToGoogleSheets(type, newRecord);
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØªØ³
async function saveToGoogleSheets(type, data) {
    const formData = new FormData();
    formData.append('action', 'addRecord');
    formData.append('type', type);
    formData.append('data', JSON.stringify(data));

    await fetch(API_URL, {
        method: 'POST',
        body: formData
    });
}

// ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
let currentSection = 'inputs'; // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯Ø§Ù„Ø©

function showSection(section) {
    currentSection = section; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    let content = '';
    
    switch(section) {
        case 'inputs':
            content = `
                <button onclick="showForm('inputs')">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„</button>
                ${renderTable('inputs')}
            `;
            break;
        case 'expenses':
            content = `
                <button onclick="showForm('expenses')">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                ${renderTable('expenses')}
            `;
            break;
        case 'total':
            content = renderSummary();
            break;
    }
    
    document.getElementById('contentSection').innerHTML = content;
}

function renderTable(type) {
    return `
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„ÙˆØµÙ</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                ${records[type].map(record => `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.amount}</td>
                        <td>${record.description}</td>
                        <td>${record.date}</td> <!-- ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ø³Ø¨Ù‚Ù‹Ø§ -->
                        <td>
                            <button onclick="editRecord('${type}', '${record.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteRecord('${type}', '${record.id}')">Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}



function exportToExcel(type) {
  const data = records[type];
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data");
  XLSX.writeFile(wb, `${type}_export.xlsx`);
}

function renderSummary() {
    console.log("Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° renderSummary...");

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ contentSection Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡
    const contentSection = document.getElementById('contentSection');
    if (!contentSection) {
        console.error("ğŸš¨ Ø§Ù„Ø¹Ù†ØµØ± 'contentSection' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©.");
        return;
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø©
    if (!records || !Array.isArray(records.inputs) || !Array.isArray(records.expenses)) {
        console.error("ğŸš¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­:", records);
        contentSection.innerHTML = "<p>âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©.</p>";
        contentSection.style.display = 'block'; // ØªØ£ÙƒÙŠØ¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù†ØµØ±
        return;
    }

    console.log("âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©:", records);

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØµÙÙˆÙØ§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª
    if (records.inputs.length === 0 && records.expenses.length === 0) {
        console.warn("âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø£Ùˆ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.");
        contentSection.innerHTML = "<p>âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©.</p>";
        contentSection.style.display = 'block'; // ØªØ£ÙƒÙŠØ¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù†ØµØ±
        return;
    }

    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù…
    const totalInputs = records.inputs.reduce((sum, record) => {
        console.log("ğŸ”¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¯Ø®Ù„:", record);
        return sum + (parseFloat(record.amount) || 0);
    }, 0);

    const totalExpenses = records.expenses.reduce((sum, record) => {
        console.log("ğŸ”¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØµØ±ÙˆÙ:", record);
        return sum + (parseFloat(record.amount) || 0);
    }, 0);

    const netTotal = totalInputs - totalExpenses;

    console.log("ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:", { totalInputs, totalExpenses, netTotal });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    contentSection.innerHTML = `
    document.body.appendChild(contentSection);

   contentSection.innerText = "ğŸš€ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«! Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª: " + totalInputs + " $";

    `;

    // ØªØ£ÙƒÙŠØ¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    contentSection.style.display = 'block';

    console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« contentSection Ø¨Ù†Ø¬Ø§Ø­.");
}





// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
function showForm(type) {
    const formHTML = `
        <div class="form-overlay" onclick="closeForm()">
            <div class="entry-form" onclick="event.stopPropagation()"> <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ -->
                <h3>${type === 'inputs' ? 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„' : 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ'}</h3>
                <form onsubmit="submitForm(event, '${type}')">
                    <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" required>
                    <textarea placeholder="Ø§Ù„ÙˆØµÙ" rows="3"></textarea>
                    <button type="submit">Ø­ÙØ¸</button>
                    <button type="button" onclick="closeForm()">Ø¥Ù„ØºØ§Ø¡</button>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', formHTML);
    document.querySelector('.form-overlay').style.display = 'block';
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function closeForm() {
    const formOverlay = document.querySelector('.form-overlay');
    if (formOverlay) formOverlay.remove();
}
// Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
async function submitForm(event, type) {
    event.preventDefault();
    const form = event.target;
    const amount = form.querySelector('input').value;
    const description = form.querySelector('textarea').value;

    if (!amount || !description) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
        return;
    }

    const newRecord = {
        amount: amount,
        description: description,
        date: new Date().toLocaleString(),
        id: Date.now().toString()
    };

    try {
        await saveToGoogleSheets(type, newRecord);
        records[type].push(newRecord);
        updateTables();
        closeForm(); // <-- Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
    } catch (error) {
        alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
    }
}
// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
function updateTables() {
    if (currentSection === 'inputs' || currentSection === 'expenses') {
        showSection(currentSection);
    }
}


</script>
</body>
</html>